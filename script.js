   const iroha = [
                ["ã‚","ï¼ï¼ãƒ»ï¼ï¼"], //ã‚ï¼0
                ["ã„","ãƒ»ï¼"], //ã„ï¼1
                ["ã†","ãƒ»ãƒ»ï¼"], //ã†ï¼2
                ["ãˆ","ï¼ãƒ»ï¼ï¼ï¼"], //ãˆï¼3
                ["ãŠ","ãƒ»ï¼ãƒ»ãƒ»ãƒ»"], //ãŠï¼4
                ["ã‹","ãƒ»ï¼ãƒ»ãƒ»"], //ã‹ï¼5
                ["ã","ï¼ãƒ»ï¼ãƒ»ãƒ»"], //ãï¼6
                ["ã","ãƒ»ãƒ»ãƒ»ï¼"], //ãï¼7
                ["ã‘","ï¼ãƒ»ï¼ï¼"], //ã‘ï¼8
                ["ã“","ï¼ï¼ï¼ï¼"], //ã“ï¼9
                ["ã•","ï¼ãƒ»ï¼ãƒ»ï¼"], //ã•ï¼10
                ["ã—","ï¼ï¼ãƒ»ï¼ãƒ»"], //ã—ï¼11
                ["ã™","ï¼ï¼ï¼ãƒ»ï¼"], //ã™ï¼12
                ["ã›","ãƒ»ï¼ï¼ï¼ãƒ»"], //ã›ï¼13
                ["ã","ï¼ï¼ï¼ãƒ»"], //ãï¼14
                ["ãŸ","ï¼ãƒ»"], //ãŸï¼15
                ["ã¡","ãƒ»ãƒ»ï¼ãƒ»"], //ã¡ï¼16
                ["ã¤","ãƒ»ï¼ï¼ãƒ»"], //ã¤ï¼17
                ["ã¦","ãƒ»ï¼ãƒ»ï¼ï¼"], //ã¦ï¼18
                ["ã¨","ãƒ»ãƒ»ï¼ãƒ»ãƒ»"], //ã¨ï¼19
                ["ãª","ãƒ»ï¼ãƒ»"], //ãªï¼20
                ["ã«","ï¼ãƒ»ï¼ãƒ»"], //ã«ï¼21
                ["ã¬","ãƒ»ãƒ»ãƒ»ãƒ»"], //ã¬ï¼22
                ["ã­","ï¼ï¼ãƒ»ï¼"], //ã­ï¼23
                ["ã®","ãƒ»ãƒ»ï¼ï¼"], //ã®ï¼24
                ["ã¯","ï¼ãƒ»ãƒ»ãƒ»"], //ã¯ï¼25
                ["ã²","ï¼ï¼ãƒ»ãƒ»ï¼"], //ã²ï¼26
                ["ãµ","ï¼ï¼ãƒ»ãƒ»"], //ãµï¼27
                ["ã¸","ãƒ»"], //ã¸ï¼28
                ["ã»","ï¼ãƒ»ãƒ»"], //ã»ï¼29
                ["ã¾","ï¼ãƒ»ãƒ»ï¼"], //ã¾ï¼30
                ["ã¿","ãƒ»ãƒ»ï¼ãƒ»ï¼"], //ã¿ï¼31
                ["ã‚€","ï¼"], //ã‚€ï¼32
                ["ã‚","ï¼ãƒ»ãƒ»ãƒ»ï¼"], //ã‚ï¼33
                ["ã‚‚","ï¼ãƒ»ãƒ»ï¼ãƒ»"], //ã‚‚ï¼34
                ["ã‚„","ãƒ»ï¼ï¼"], //ã‚„ï¼35
                ["ã‚","ãƒ»ï¼ãƒ»ãƒ»ï¼"], //ã‚ï¼36
                ["ã‚†","ï¼ãƒ»ãƒ»ï¼ï¼"], //ã‚†ï¼37
                ["ã‚‘","ãƒ»ï¼ï¼ãƒ»ãƒ»"], //ã‚‘ï¼38
                ["ã‚ˆ","ï¼ï¼"], //ã‚ˆï¼39
                ["ã‚‰","ãƒ»ãƒ»ãƒ»"], //ã‚‰ï¼40
                ["ã‚Š","ï¼ï¼ãƒ»"], //ã‚Šï¼41
                ["ã‚‹","ï¼ãƒ»ï¼ï¼ãƒ»"], //ã‚‹ï¼42
                ["ã‚Œ","ï¼ï¼ï¼"], //ã‚Œï¼43
                ["ã‚","ãƒ»ï¼ãƒ»ï¼"], //ã‚ï¼44
                ["ã‚","ï¼ãƒ»ï¼"], //ã‚ï¼45
                ["ã‚’","ãƒ»ï¼ï¼ï¼"], //ã‚’ï¼46
                ["ã‚“","ãƒ»ï¼ãƒ»ï¼ãƒ»"], //ã‚“ï¼47
                ["ãŒ","ãƒ»ï¼ãƒ»ãƒ»ï¼ãƒ»ãƒ»"], //ãŒï¼48
                ["ã","ï¼ãƒ»ï¼ãƒ»ãƒ»ï¼ãƒ»ãƒ»"], //ãï¼49
                ["ã","ãƒ»ãƒ»ãƒ»ï¼ï¼ãƒ»ãƒ»"], //ãï¼50
                ["ã’","ï¼ãƒ»ï¼ï¼ï¼ãƒ»ãƒ»"], //ã’ï¼51
                ["ã”","ï¼ï¼ï¼ï¼ï¼ãƒ»ãƒ»"], //ã”ï¼52
                ["ã–","ï¼ãƒ»ï¼ãƒ»ï¼ï¼ãƒ»ãƒ»"], //ã–ï¼53
                ["ã˜","ï¼ï¼ãƒ»ï¼ãƒ»ï¼ãƒ»ãƒ»"], //ã˜ï¼54
                ["ãš","ï¼ï¼ï¼ãƒ»ï¼ï¼ãƒ»ãƒ»"], //ãšï¼55
                ["ãœ","ãƒ»ï¼ï¼ï¼ãƒ»ï¼ãƒ»ãƒ»"], //ãœï¼56
                ["ã","ï¼ï¼ï¼ãƒ»ï¼ãƒ»ãƒ»"], //ãï¼57
                ["ã ","ï¼ãƒ»ï¼ãƒ»ãƒ»"], //ã ï¼58
                ["ã¢","ãƒ»ãƒ»ï¼ãƒ»ï¼ãƒ»ãƒ»"], //ã¢ï¼59
                ["ã¥","ãƒ»ï¼ï¼ãƒ»ï¼ãƒ»ãƒ»"], //ã¥ï¼60
                ["ã§","ãƒ»ï¼ãƒ»ï¼ï¼ï¼ãƒ»ãƒ»"], //ã§ï¼61
                ["ã©","ãƒ»ãƒ»ï¼ãƒ»ãƒ»ï¼ãƒ»ãƒ»"], //ã©ï¼62
                ["ã°","ï¼ãƒ»ãƒ»ãƒ»ï¼ãƒ»ãƒ»"], //ã°ï¼63
                ["ã³","ï¼ï¼ãƒ»ãƒ»ï¼ï¼ãƒ»ãƒ»"], //ã³ï¼64
                ["ã¶","ï¼ï¼ãƒ»ãƒ»ï¼ãƒ»ãƒ»"], //ã¶ï¼65
                ["ã¹","ãƒ»ï¼ãƒ»ãƒ»"], //ã¹ï¼66
                ["ã¼","ï¼ãƒ»ãƒ»ï¼ãƒ»ãƒ»"], //ã¼ï¼67
                ["ã±","ï¼ãƒ»ãƒ»ãƒ»ï¼ãƒ»ãƒ»ï¼ï¼ãƒ»"], //ã±ï¼68
                ["ã´","ï¼ï¼ãƒ»ãƒ»ï¼ï¼ãƒ»ãƒ»ï¼ï¼ãƒ»"], //ã´ï¼69
                ["ã·","ï¼ï¼ãƒ»ãƒ»ï¼ãƒ»ãƒ»ï¼ï¼ãƒ»"], //ã·ï¼70
                ["ãº","ãƒ»ï¼ãƒ»ãƒ»ï¼ï¼ãƒ»"], //ãºï¼71
                ["ã½","ï¼ãƒ»ãƒ»ï¼ãƒ»ãƒ»ï¼ï¼ãƒ»"], //ã½ï¼72
                ["ãƒ¼","ãƒ»ï¼ï¼ãƒ»ï¼"], //ãƒ¼ ï¼73
                ["ã€","ãƒ»ï¼ãƒ»ï¼ãƒ»ï¼"], //ã€ ï¼74
                ["(","ï¼ãƒ»ï¼ï¼ãƒ»ï¼"], //( ï¼75
                [")","ãƒ»ï¼ãƒ»ãƒ»ï¼ãƒ»"], //) ï¼76  
                ["0","ï¼ï¼ï¼ï¼ï¼"], //0 ï¼77
                ["1","ãƒ»ï¼ï¼ï¼ï¼"], //1 ï¼78
                ["2","ãƒ»ãƒ»ï¼ï¼ï¼"], //2 ï¼79
                ["3","ãƒ»ãƒ»ãƒ»ï¼ï¼"], //3 ï¼80
                ["4","ãƒ»ãƒ»ãƒ»ãƒ»ï¼"], //4 ï¼81
                ["5","ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»"], //5 ï¼82
                ["6","ï¼ãƒ»ãƒ»ãƒ»ãƒ»"], //6 ï¼83
                ["7","ï¼ï¼ãƒ»ãƒ»ãƒ»"], //7 ï¼84
                ["8","ï¼ï¼ï¼ãƒ»ãƒ»"], //8 ï¼85
                ["9","ï¼ï¼ï¼ï¼ãƒ»"], //9 ï¼86
                //å°æ–‡å­—ã¯å¯¾å¿œã—ã¦ã„ãªã„ã®ã§å¤§æ–‡å­—ã¨åŒã˜
                ["ã","ï¼ï¼ãƒ»ï¼ï¼"], //ãï¼87
                ["ãƒ","ãƒ»ï¼"], //ãƒï¼88
                ["ã…","ãƒ»ãƒ»ï¼"], //ã…ï¼89
                ["ã‡","ï¼ãƒ»ï¼ï¼ï¼"], //ã‡ï¼90
                ["ã‰","ãƒ»ï¼ãƒ»ãƒ»ãƒ»"], //ã‰ï¼91
                ["ã‚ƒ","ãƒ»ï¼ï¼"], //ã‚ƒï¼92
                ["ã‚…","ï¼ãƒ»ãƒ»ï¼ï¼"], //ã‚…ï¼93
                ["ã‚‡","ï¼ï¼"], //ã‚‡ï¼94
                ["ã‚","ï¼ãƒ»ï¼"], //ã‚ï¼95
                ["ã‚›","ãƒ»ãƒ»"],// æ¿ç‚¹ ï¼96
                ["ã‚œ","ãƒ»ãƒ»ï¼ï¼ãƒ»"], //åŠæ¿ç‚¹ ï¼97
                ["\n","ãƒ»ï¼ãƒ»ï¼ãƒ»ãƒ»"] //æ”¹è¡Œ ï¼98
        ];

        const ques = [
            ["é›»æ°—é€šä¿¡å¤§å­¦ãƒŸãƒ¥ãƒ¼ã‚¸ã‚¢ãƒ ã®ãƒã‚¹ã‚³ãƒƒãƒˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨è¨€ãˆã°ï¼Ÿ", "ã¾ãƒ¼ã‚‹ã™"],
            ["ã‚ã‚ŠãŒã¨ã†","ã‚ã‚ŠãŒã¨ã†"]
        ];

         const selection = [
            ["ã„ã¾ãƒãƒ¼ãƒ«ã‚¹ã¯ä½•ã‚’æŒã£ã¦ã„ã‚‹ï¼Ÿ", "ã°ãªãª","ã‚Šã‚“ã”","ã„ã¡ã”"]
        ];

        let getname;
        let iroha_name = [];
        let morse_name = [];
        let speedRatio = 1;
        let SPEED = 0.15; // ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·ã®é€Ÿã•(å‰ã®3å€é…ã„)
        let DIFFICULTY = 'normal'; //æ–‡å­—ã¨æ–‡å­—ã®é–“éš” normalãŒã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒˆ
        let frequency = 880; //ãƒ¢ãƒ¼ãƒ«ã‚¹ã®éŸ³ã®é«˜ã•
        let currentMp3Blob = null; // ä¸€ç•ªæ–°ã—ã„mp3(Binary Large Object)
        const channels = 1; //ãƒãƒ£ãƒ³ãƒãƒ«æ•°
        let loudness = 1; //éŸ³ã®å¤§ãã•

        let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let currentOscillators = [];
        let question;
        let correctanswer;
        let questionNumber = 0;

        //å…¥åŠ›å…ƒã¨å‡ºåŠ›å…ˆã‚’å¼•æ•°ã«æ¸¡ã™ã¨ã„ã‚ã¯ã‚’ãƒ¢ãƒ¼ãƒ«ã‚¹ã«å¤‰ãˆã¦å‡ºåŠ›ã™ã‚‹
        function ChangeIroha(inputID,outputID){
            morse_name = []; //åˆæœŸåŒ–
            getname = document.getElementById(inputID).value;        
            iroha_name = getname.split("");
            for(let char of iroha_name){
                const found = iroha.find(data => data[0] === char); //æ¢ç´¢
                if(found){
                    morse_name.push(found[1]);
                }else{ //æœªå®šç¾©ã®æ–‡å­—ãŒã‚ã£ãŸå ´åˆ
                    morse_name.push("ï¼Ÿ")
                }
            }
            let morse = morse_name.join('ï¼');
            document.getElementById(outputID).value = morse;
            const btn = document.getElementById("downloadBtn");
            btn.style.display = "none";
            return morse;
        }

        //ã„ã‚ã¯ã‚’ç›´æ¥å…¥ã‚Œã‚‹ã¨å¯¾å¿œã™ã‚‹ãƒ¢ãƒ¼ãƒ«ã‚¹ã‚’è¿”ã™
        function DirectChangeIroha(IROHA){
             morse_name = []; //åˆæœŸåŒ–
             IROHA = IROHA.split("");
              for(let char of IROHA){
                const found = iroha.find(data => data[0] === char); //æ¢ç´¢
                if(found){
                    morse_name.push(found[1]);
                }else{ //æœªå®šç¾©ã®æ–‡å­—ãŒã‚ã£ãŸå ´åˆ
                    morse_name.push("ï¼Ÿ")
                }
            }
            let morse = morse_name.join('ï¼');
            return morse;
        }

        // 2æ–‡å­—åˆ¤å®šã®æ¿ç‚¹ã‚„åŠæ¿ç‚¹ã®ã¤ã„ãŸæ–‡å­—ã‚’1æ–‡å­—ã«
        function Conversion(array){
            array = array.split("ã‹ã‚›").join('ãŒ');
            array = array.split("ãã‚›").join('ã');
            array = array.split("ãã‚›").join('ã');
            array = array.split("ã‘ã‚›").join('ã’');
            array = array.split("ã“ã‚›").join('ã”');
            array = array.split("ã•ã‚›").join('ã–');
            array = array.split("ã—ã‚›").join('ã˜');
            array = array.split("ã™ã‚›").join('ãš');
            array = array.split("ã›ã‚›").join('ãœ');
            array = array.split("ãã‚›").join('ã');
            array = array.split("ãŸã‚›").join('ã ');
            array = array.split("ã¡ã‚›").join('ã¢');
            array = array.split("ã¤ã‚›").join('ã¥');
            array = array.split("ã¦ã‚›").join('ã§');
            array = array.split("ã¨ã‚›").join('ã©');
            array = array.split("ã¯ã‚›").join('ã°');
            array = array.split("ã²ã‚›").join('ã³');
            array = array.split("ãµã‚›").join('ã¶');
            array = array.split("ã¸ã‚›").join('ã¹');
            array = array.split("ã»ã‚›").join('ã¼');
            array = array.split("ã¯ã‚œ").join('ã±');
            array = array.split("ã²ã‚œ").join('ã´');
            array = array.split("ãµã‚œ").join('ã·');
            array = array.split("ã¸ã‚œ").join('ãº');
            array = array.split("ã»ã‚œ").join('ã½');
            return array;
        }

        // ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·ã®å†ç”Ÿ
        function playMorse(id){
            // const morse = document.getElementById(id).value;
            let morse =[];
            if(id == 'NAME'){morse = morse_name.join('ï¼');}
            else{morse = document.getElementById(id).value;}
        
            // å‰å›ã®éŸ³ã‚’æ­¢ã‚ã‚‹
            currentOscillators.forEach(osc => {
                try { osc.stop(); } catch (e) {}
            });
            currentOscillators = [];

            // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆéŸ³ãŒé€”ä¸­ã§æ®‹ã‚‰ãªã„ã‚ˆã†ã«ï¼‰
            audioCtx.close();

            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const dot = SPEED * speedRatio; 
            let time = audioCtx.currentTime; // å†ç”Ÿé–‹å§‹æ™‚åˆ»
            for(let char of morse){
                if(char === "ãƒ»"){
                    ring(audioCtx, time, dot);
                    time += dot + dot; // ã€Œãƒ»ã€ + ã€Œç©ºç™½ã€ ((1ç‚¹ + 1ç‚¹
                } else if(char === "ï¼" || char === "-"){
                    ring(audioCtx, time, dot * 3);
                    time += dot * 3 + dot; // ã€Œï¼ã€ + ã€Œç©ºç™½ã€ ((3ç‚¹ + 1ç‚¹
                } else if(char === "ï¼" && DIFFICULTY === 'normal'){
                    time += dot * 2; // æ–‡å­—ã¨æ–‡å­—ã®é–“ 3ç‚¹(ä¸Šã®ç©ºç™½åˆ† + 2ç‚¹)
                } else if(char === "ï¼" && DIFFICULTY === 'easy'){
                    time += dot * 5; // æ–‡å­—ã¨æ–‡å­—ã®é–“ 6ç‚¹(ä¸Šã®ç©ºç™½åˆ† + 5ç‚¹)
                } else if(char === "ï¼Ÿ"){ //  ?ã®å‡¦ç†ã©ã†ã—ã‚ˆã†
                    time += dot * 7;
                }
            }
        }

        //ãƒ“ãƒ¼ãƒ—éŸ³ã‚’é³´ã‚‰ã™(èãã¨ãç”¨)
        function ring(ctx, start, duration){
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            oscillator.type = "sine";
            // éŸ³é‡ã®è¨­å®š
            oscillator.frequency.setValueAtTime(frequency, start);
            gainNode.gain.setValueAtTime(loudness, start); //éŸ³é‡loudnessã§ã‚¹ã‚¿ãƒ¼ãƒˆ
            gainNode.gain.setValueAtTime(0, start + duration); //durationåˆ†ãŸã£ãŸã‚‰0ã«ã™ã‚‹ 
            // éŸ³ã®è¨­å®š
            oscillator.connect(gainNode).connect(ctx.destination); //éŸ³é‡èª¿æ•´->ã‚¹ãƒ”ãƒ¼ã‚«ã«æ¥ç¶š
            oscillator.start(start); //startæ™‚ã«å§‹ã‚ã‚‹
            oscillator.stop(start + duration);//durationçµŒéã§çµ‚äº†

            currentOscillators.push(oscillator); //ç¾åœ¨ã®ã‚‚ã®ã‚’è¨˜éŒ²
        }

        //ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·ã®æ›¸ã‹ã‚Œã¦ã„ã‚‹å ´æ‰€ã‚’æŒ‡å®šã™ã‚‹ã¨ã„ã‚ã¯ã«å¤‰æ›´
        function ChangeMorse(inputID){
            const morseInput = document.getElementById(inputID).value;
            const getMorse = morseInput.split("ï¼");
            let result = "";
            for(let code of getMorse){
                const found = iroha.find(data => data[1] === code);
                if(found){
                    result += found[0];
                }else{
                    result += "ï¼Ÿ";
                }
            }
            result = Conversion(result);
            window.alert(result);
            if(morseInput === morse_name.join('ï¼')){window.alert("æ­£è§£ï¼ï¼");}
            else{window.alert("ä¸æ­£è§£...");}
            return result;
        }

        //ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·ã‚’ç›´æ¥å…¥ã‚Œã‚‹ã¨å¯¾å¿œã™ã‚‹ã„ã‚ã¯ã‚’ã‹ãˆã™
        function DirectChangeMorse(morse){
            const getMorse = morse.split("ï¼");
            let result = "";
            for(let code of getMorse){
                const found = iroha.find(data => data[1] === code);
                if(found){
                    result += found[0];
                }else{
                    result += "ï¼Ÿ";
                }
            }
            return result;
        }



        //é€Ÿã•å¤‰æ›´
        function ChangeSpeed(ratio){
            speedRatio = 1.0 / ratio;
            const btn = document.getElementById("downloadBtn");
            btn.style.display = "none";
        }

        //ç©ºç™½ã®æ™‚é–“å¤‰æ›´
        function ChangeDiff(diff){
            if(diff === 'easy'){DIFFICULTY = 'easy';}
            else if(diff === 'hard'){DIFFICULTY = 'hard';}
        }

        //ã‚¯ã‚¤ã‚ºã®å‡ºé¡Œ
        function AskQuestion(id){
            question = ques[questionNumber][0];
            correctanswer = ques[questionNumber][1];
            correctanswer = DirectChangeIroha(correctanswer);
            document.getElementById(id).textContent = question;
        }

        //ã‚¯ã‚¤ã‚ºã®ç­”ãˆåˆã‚ã›
        function CheckAnswer(id){
            answer = document.getElementById(id).value;
            if(answer === correctanswer){
                window.alert("æ­£è§£ï¼ï¼\nç­”ãˆ: " + DirectChangeMorse(correctanswer) +"\n" + "ãƒ¢ãƒ¼ãƒ«ã‚¹: " + correctanswer);
            }else{window.alert("ä¸æ­£è§£...\nç­”ãˆ: " + DirectChangeMorse(correctanswer) +"\n"
                + "\nã‚ãªãŸã®å…¥åŠ›: " +  DirectChangeMorse(answer) + "\næ­£è§£ã®ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·: " + correctanswer
                 + "\nã‚ãªãŸã®å…¥åŠ›ã—ãŸãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·: " + answer);}
        }

        // ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·ã‚’mp3ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›
        async function morseToMp3(morseString) {
            const sampleRate = 44100; //ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°å‘¨æ³¢æ•°
            let unit = SPEED * speedRatio;
            let totalDuration = 0;

            for (let char of morseString) {
                if (char === "ãƒ»"){totalDuration += unit + unit;}
                else if (char === "ï¼"){totalDuration += unit * 3 + unit;}
                else if (char === "ï¼"){totalDuration += unit * 2;}
            }


            const offlineCtx = new OfflineAudioContext(channels, sampleRate * totalDuration, sampleRate);
            let time = 0;

            for (let char of morseString) {
                if (char === "ãƒ»") {
                    addBeep(offlineCtx, time, unit, frequency);
                    time += unit + unit;
                } else if (char === "ï¼") {
                    addBeep(offlineCtx, time, unit * 3, frequency);
                    time += unit * 3 + unit;
                } else if (char === "ï¼") {
                    time += unit * 2;
                }
            }

            const audioBuffer = await offlineCtx.startRendering();
            return audioBufferToMp3(audioBuffer);
        }

        // éŸ³ã‚’ãƒ“ãƒ¼ãƒ—éŸ³ã§é³´ã‚‰ã™(éŒ²éŸ³ç”¨)
        function addBeep(ctx, startTime, duration, frequency) {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.frequency.value = frequency;
            osc.type = 'sine';
            osc.connect(gain);
            gain.connect(ctx.destination);
            gain.gain.setValueAtTime(loudness, startTime);
            gain.gain.setValueAtTime(0, startTime + duration);
            osc.start(startTime);
            osc.stop(startTime + duration);
        }

        // AudioBuffer â†’ MP3 ã«å¤‰æ›
        function audioBufferToMp3(audioBuffer) {
            const samples = audioBuffer.getChannelData(0);
            const mp3encoder = new lamejs.Mp3Encoder(channels, audioBuffer.sampleRate, 128);
            const sampleBlockSize = 1152;
            const mp3Data = [];

            for (let i = 0; i < samples.length; i += sampleBlockSize) {
                const sampleChunk = samples.subarray(i, i + sampleBlockSize);
                const int16Samples = new Int16Array(sampleChunk.length);
                for (let j = 0; j < sampleChunk.length; j++) {
                    int16Samples[j] = sampleChunk[j] * 32767;
                }
                const mp3buf = mp3encoder.encodeBuffer(int16Samples);
                if (mp3buf.length > 0) mp3Data.push(mp3buf);
            }

            const mp3buf = mp3encoder.flush();
            if (mp3buf.length > 0) mp3Data.push(mp3buf);

            return new Blob(mp3Data, { type: 'audio/mp3' });
        }

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }


        async function generateMorseMp3(id) {
        const morse = document.getElementById(id).value;
            if (!morse.trim()) {
                alert("ä½•ã‚‚å…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“");
                return;
            }

            const blob = await morseToMp3(morse);
            currentMp3Blob = blob;

            // æ—¢å­˜ã®downloadBtnï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ä¿å­˜ï¼‰ã‚‚æ®‹ã™
            const btn = document.getElementById("downloadBtn");
            btn.style.display = "inline-block";
            btn.onclick = () => downloadBlob(currentMp3Blob, "morse.mp3");

            // â˜…è¿½åŠ ï¼šã‚¹ãƒãƒ›ç”¨ã®é•·æŠ¼ã—ä¿å­˜ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
            const link = document.createElement("a");
            link.href = URL.createObjectURL(currentMp3Blob);
            link.download = "morse.mp3";
            link.textContent = "ğŸ“¥ ã‚¹ãƒãƒ›ç”¨ï¼šMP3ã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜";
            link.style.display = "block";
            link.style.marginTop = "10px";
            link.id = "longPressLink";

            const existing = document.getElementById("longPressLink");
            if (existing) existing.remove(); // å†ç”Ÿæˆæ™‚ã«é‡è¤‡é˜²æ­¢
            btn.insertAdjacentElement("afterend", link);
        }

        //éŸ³ã®æµã‚Œã‚‹é€Ÿã•ã‚’è¿”ã™ã€€ã€‡å€é€Ÿ
        function getSpeedRatio(){ 
            return speedRatio;
        }

        //éŸ³ã®é«˜ã•ã‚’è¿”ã™ã€€åŸºæœ¬880Hz
        function getFrequency(){
            return frequency;
        }

        //éŸ³ã®å¤§ãã•ã‚’è¿”ã™ 0~1
        function getVelocity(){ 
            return loudness;
        }
                
    function appendText(char,id) {
      const textbox = document.getElementById(id);
      textbox.value += char;
    }

    function deleteLast(id) {
      const textbox = document.getElementById(id);
      // æœ€å¾Œã®1æ–‡å­—ã‚’å‰Šé™¤ï¼ˆUTF-16ã‚³ãƒ¼ãƒ‰å˜ä½ã«å¯¾å¿œï¼‰
      textbox.value = textbox.value.slice(0, -1);
    }

    function clearText(id) {
      const textbox = document.getElementById(id);
      textbox.value = '';
    }
