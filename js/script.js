   const iroha = [
                ["ã‚","ï¼ï¼ãƒ»ï¼ï¼"], //ã‚ï¼0
                ["ã„","ãƒ»ï¼"], //ã„ï¼1
                ["ã†","ãƒ»ãƒ»ï¼"], //ã†ï¼2
                ["ãˆ","ï¼ãƒ»ï¼ï¼ï¼"], //ãˆï¼3
                ["ãŠ","ãƒ»ï¼ãƒ»ãƒ»ãƒ»"], //ãŠï¼4
                ["ã‹","ãƒ»ï¼ãƒ»ãƒ»"], //ã‹ï¼5
                ["ã","ï¼ãƒ»ï¼ãƒ»ãƒ»"], //ãï¼6
                ["ã","ãƒ»ãƒ»ãƒ»ï¼"], //ãï¼7
                ["ã‘","ï¼ãƒ»ï¼ï¼"], //ã‘ï¼8
                ["ã“","ï¼ï¼ï¼ï¼"], //ã“ï¼9
                ["ã•","ï¼ãƒ»ï¼ãƒ»ï¼"], //ã•ï¼10
                ["ã—","ï¼ï¼ãƒ»ï¼ãƒ»"], //ã—ï¼11
                ["ã™","ï¼ï¼ï¼ãƒ»ï¼"], //ã™ï¼12
                ["ã›","ãƒ»ï¼ï¼ï¼ãƒ»"], //ã›ï¼13
                ["ã","ï¼ï¼ï¼ãƒ»"], //ãï¼14
                ["ãŸ","ï¼ãƒ»"], //ãŸï¼15
                ["ã¡","ãƒ»ãƒ»ï¼ãƒ»"], //ã¡ï¼16
                ["ã¤","ãƒ»ï¼ï¼ãƒ»"], //ã¤ï¼17
                ["ã¦","ãƒ»ï¼ãƒ»ï¼ï¼"], //ã¦ï¼18
                ["ã¨","ãƒ»ãƒ»ï¼ãƒ»ãƒ»"], //ã¨ï¼19
                ["ãª","ãƒ»ï¼ãƒ»"], //ãªï¼20
                ["ã«","ï¼ãƒ»ï¼ãƒ»"], //ã«ï¼21
                ["ã¬","ãƒ»ãƒ»ãƒ»ãƒ»"], //ã¬ï¼22
                ["ã­","ï¼ï¼ãƒ»ï¼"], //ã­ï¼23
                ["ã®","ãƒ»ãƒ»ï¼ï¼"], //ã®ï¼24
                ["ã¯","ï¼ãƒ»ãƒ»ãƒ»"], //ã¯ï¼25
                ["ã²","ï¼ï¼ãƒ»ãƒ»ï¼"], //ã²ï¼26
                ["ãµ","ï¼ï¼ãƒ»ãƒ»"], //ãµï¼27
                ["ã¸","ãƒ»"], //ã¸ï¼28
                ["ã»","ï¼ãƒ»ãƒ»"], //ã»ï¼29
                ["ã¾","ï¼ãƒ»ãƒ»ï¼"], //ã¾ï¼30
                ["ã¿","ãƒ»ãƒ»ï¼ãƒ»ï¼"], //ã¿ï¼31
                ["ã‚€","ï¼"], //ã‚€ï¼32
                ["ã‚","ï¼ãƒ»ãƒ»ãƒ»ï¼"], //ã‚ï¼33
                ["ã‚‚","ï¼ãƒ»ãƒ»ï¼ãƒ»"], //ã‚‚ï¼34
                ["ã‚„","ãƒ»ï¼ï¼"], //ã‚„ï¼35
                ["ã‚","ãƒ»ï¼ãƒ»ãƒ»ï¼"], //ã‚ï¼36
                ["ã‚†","ï¼ãƒ»ãƒ»ï¼ï¼"], //ã‚†ï¼37
                ["ã‚‘","ãƒ»ï¼ï¼ãƒ»ãƒ»"], //ã‚‘ï¼38
                ["ã‚ˆ","ï¼ï¼"], //ã‚ˆï¼39
                ["ã‚‰","ãƒ»ãƒ»ãƒ»"], //ã‚‰ï¼40
                ["ã‚Š","ï¼ï¼ãƒ»"], //ã‚Šï¼41
                ["ã‚‹","ï¼ãƒ»ï¼ï¼ãƒ»"], //ã‚‹ï¼42
                ["ã‚Œ","ï¼ï¼ï¼"], //ã‚Œï¼43
                ["ã‚","ãƒ»ï¼ãƒ»ï¼"], //ã‚ï¼44
                ["ã‚","ï¼ãƒ»ï¼"], //ã‚ï¼45
                ["ã‚’","ãƒ»ï¼ï¼ï¼"], //ã‚’ï¼46
                ["ã‚“","ãƒ»ï¼ãƒ»ï¼ãƒ»"], //ã‚“ï¼47
                ["ãŒ","ãƒ»ï¼ãƒ»ãƒ»ï¼ãƒ»ãƒ»"], //ãŒï¼48
                ["ã","ï¼ãƒ»ï¼ãƒ»ãƒ»ï¼ãƒ»ãƒ»"], //ãï¼49
                ["ã","ãƒ»ãƒ»ãƒ»ï¼ï¼ãƒ»ãƒ»"], //ãï¼50
                ["ã’","ï¼ãƒ»ï¼ï¼ï¼ãƒ»ãƒ»"], //ã’ï¼51
                ["ã”","ï¼ï¼ï¼ï¼ï¼ãƒ»ãƒ»"], //ã”ï¼52
                ["ã–","ï¼ãƒ»ï¼ãƒ»ï¼ï¼ãƒ»ãƒ»"], //ã–ï¼53
                ["ã˜","ï¼ï¼ãƒ»ï¼ãƒ»ï¼ãƒ»ãƒ»"], //ã˜ï¼54
                ["ãš","ï¼ï¼ï¼ãƒ»ï¼ï¼ãƒ»ãƒ»"], //ãšï¼55
                ["ãœ","ãƒ»ï¼ï¼ï¼ãƒ»ï¼ãƒ»ãƒ»"], //ãœï¼56
                ["ã","ï¼ï¼ï¼ãƒ»ï¼ãƒ»ãƒ»"], //ãï¼57
                ["ã ","ï¼ãƒ»ï¼ãƒ»ãƒ»"], //ã ï¼58
                ["ã¢","ãƒ»ãƒ»ï¼ãƒ»ï¼ãƒ»ãƒ»"], //ã¢ï¼59
                ["ã¥","ãƒ»ï¼ï¼ãƒ»ï¼ãƒ»ãƒ»"], //ã¥ï¼60
                ["ã§","ãƒ»ï¼ãƒ»ï¼ï¼ï¼ãƒ»ãƒ»"], //ã§ï¼61
                ["ã©","ãƒ»ãƒ»ï¼ãƒ»ãƒ»ï¼ãƒ»ãƒ»"], //ã©ï¼62
                ["ã°","ï¼ãƒ»ãƒ»ãƒ»ï¼ãƒ»ãƒ»"], //ã°ï¼63
                ["ã³","ï¼ï¼ãƒ»ãƒ»ï¼ï¼ãƒ»ãƒ»"], //ã³ï¼64
                ["ã¶","ï¼ï¼ãƒ»ãƒ»ï¼ãƒ»ãƒ»"], //ã¶ï¼65
                ["ã¹","ãƒ»ï¼ãƒ»ãƒ»"], //ã¹ï¼66
                ["ã¼","ï¼ãƒ»ãƒ»ï¼ãƒ»ãƒ»"], //ã¼ï¼67
                ["ã±","ï¼ãƒ»ãƒ»ãƒ»ï¼ãƒ»ãƒ»ï¼ï¼ãƒ»"], //ã±ï¼68
                ["ã´","ï¼ï¼ãƒ»ãƒ»ï¼ï¼ãƒ»ãƒ»ï¼ï¼ãƒ»"], //ã´ï¼69
                ["ã·","ï¼ï¼ãƒ»ãƒ»ï¼ãƒ»ãƒ»ï¼ï¼ãƒ»"], //ã·ï¼70
                ["ãº","ãƒ»ï¼ãƒ»ãƒ»ï¼ï¼ãƒ»"], //ãºï¼71
                ["ã½","ï¼ãƒ»ãƒ»ï¼ãƒ»ãƒ»ï¼ï¼ãƒ»"], //ã½ï¼72
                ["ãƒ¼","ãƒ»ï¼ï¼ãƒ»ï¼"], //ãƒ¼ ï¼73
                ["ã€","ãƒ»ï¼ãƒ»ï¼ãƒ»ï¼"], //ã€ ï¼74
                ["ã€‚","ãƒ»ï¼ãƒ»ï¼ãƒ»ãƒ»"], //ã€‚ ï¼98ã€€æ”¹è¡Œã‚’èª­ç‚¹ã«
                ["(","ï¼ãƒ»ï¼ï¼ãƒ»ï¼"], //( ï¼75
                [")","ãƒ»ï¼ãƒ»ãƒ»ï¼ãƒ»"], //) ï¼76  
                ["0","ï¼ï¼ï¼ï¼ï¼"], //0 ï¼77
                ["1","ãƒ»ï¼ï¼ï¼ï¼"], //1 ï¼78
                ["2","ãƒ»ãƒ»ï¼ï¼ï¼"], //2 ï¼79
                ["3","ãƒ»ãƒ»ãƒ»ï¼ï¼"], //3 ï¼80
                ["4","ãƒ»ãƒ»ãƒ»ãƒ»ï¼"], //4 ï¼81
                ["5","ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»"], //5 ï¼82
                ["6","ï¼ãƒ»ãƒ»ãƒ»ãƒ»"], //6 ï¼83
                ["7","ï¼ï¼ãƒ»ãƒ»ãƒ»"], //7 ï¼84
                ["8","ï¼ï¼ï¼ãƒ»ãƒ»"], //8 ï¼85
                ["9","ï¼ï¼ï¼ï¼ãƒ»"], //9 ï¼86
                //å°æ–‡å­—ã¯å¯¾å¿œã—ã¦ã„ãªã„ã®ã§å¤§æ–‡å­—ã¨åŒã˜
                ["ã","ï¼ï¼ãƒ»ï¼ï¼"], //ãï¼87
                ["ãƒ","ãƒ»ï¼"], //ãƒï¼88
                ["ã…","ãƒ»ãƒ»ï¼"], //ã…ï¼89
                ["ã‡","ï¼ãƒ»ï¼ï¼ï¼"], //ã‡ï¼90
                ["ã‰","ãƒ»ï¼ãƒ»ãƒ»ãƒ»"], //ã‰ï¼91
                ["ã‚ƒ","ãƒ»ï¼ï¼"], //ã‚ƒï¼92
                ["ã‚…","ï¼ãƒ»ãƒ»ï¼ï¼"], //ã‚…ï¼93
                ["ã‚‡","ï¼ï¼"], //ã‚‡ï¼94
                ["ã‚","ï¼ãƒ»ï¼"], //ã‚ï¼95
                ["ã‚›","ãƒ»ãƒ»"],// æ¿ç‚¹ ï¼96
                ["ã‚œ","ãƒ»ãƒ»ï¼ï¼ãƒ»"], //åŠæ¿ç‚¹ ï¼97
                ["\n","ãƒ»ï¼ãƒ»ï¼ãƒ»ãƒ»"], //æ”¹è¡Œ ï¼98
                ["ã£","ãƒ»ï¼ï¼ãƒ»"], //ã£ï¼99
                ["",""], // åŒºåˆ‡ã‚Šé€£ç¶šã§ã‚‚okã€€-100
                /*ä»¥ä¸‹å…¨è§’ */
                ["ï¼ˆ","ï¼ãƒ»ï¼ï¼ãƒ»ï¼"], //( ï¼101
                ["ï¼‰","ãƒ»ï¼ãƒ»ãƒ»ï¼ãƒ»"], //) ï¼102 
                ["ï¼","ï¼ï¼ï¼ï¼ï¼"], //0 ï¼103
                ["ï¼‘","ãƒ»ï¼ï¼ï¼ï¼"], //1 ï¼104
                ["ï¼’","ãƒ»ãƒ»ï¼ï¼ï¼"], //2 ï¼105
                ["ï¼“","ãƒ»ãƒ»ãƒ»ï¼ï¼"], //3 ï¼106
                ["ï¼”","ãƒ»ãƒ»ãƒ»ãƒ»ï¼"], //4 ï¼107
                ["ï¼•","ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»"], //5 ï¼108
                ["ï¼–","ï¼ãƒ»ãƒ»ãƒ»ãƒ»"], //6 ï¼109
                ["ï¼—","ï¼ï¼ãƒ»ãƒ»ãƒ»"], //7 ï¼110
                ["ï¼˜","ï¼ï¼ï¼ãƒ»ãƒ»"], //8 ï¼111
                ["ï¼™","ï¼ï¼ï¼ï¼ãƒ»"], //9 ï¼112
        ];

         const rome = [
            ["A","ãƒ»ï¼"],
            ["B","ï¼ãƒ»ãƒ»ãƒ»"],
            ["C","ï¼ãƒ»ï¼ãƒ»"],
            ["D","ï¼ãƒ»ãƒ»"],
            ["E","ãƒ»"],
            ["F","ãƒ»ãƒ»ï¼ãƒ»"],
            ["G","ï¼ï¼ãƒ»"],
            ["H","ãƒ»ãƒ»ãƒ»ãƒ»"],
            ["I","ãƒ»ãƒ»"],
            ["J","ãƒ»ï¼ï¼ï¼"],
            ["K","ï¼ãƒ»ï¼"],
            ["L","ãƒ»ï¼ãƒ»ãƒ»"],
            ["M","ï¼ï¼"],
            ["N","ï¼ãƒ»"],
            ["O","ï¼ï¼ï¼"],
            ["P","ãƒ»ï¼ï¼ãƒ»"],
            ["Q","ï¼ï¼ãƒ»ï¼"],
            ["R","ãƒ»ï¼ãƒ»"],
            ["S","ãƒ»ãƒ»ãƒ»"],
            ["T","ï¼"],
            ["U","ãƒ»ãƒ»ï¼"],
            ["V","ãƒ»ãƒ»ãƒ»ï¼"],
            ["W","ãƒ»ï¼ï¼"],
            ["X","ï¼ãƒ»ãƒ»ï¼"],
            ["Y","ï¼ãƒ»ï¼ï¼"],
            ["Z","ï¼ï¼ãƒ»ãƒ»"],
            ["0","ï¼ï¼ï¼ï¼ï¼"], 
            ["1","ãƒ»ï¼ï¼ï¼ï¼"], 
            ["2","ãƒ»ãƒ»ï¼ï¼ï¼"], 
            ["3","ãƒ»ãƒ»ãƒ»ï¼ï¼"],
            ["4","ãƒ»ãƒ»ãƒ»ãƒ»ï¼"], 
            ["5","ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»"], 
            ["6","ï¼ãƒ»ãƒ»ãƒ»ãƒ»"],
            ["7","ï¼ï¼ãƒ»ãƒ»ãƒ»"], 
            ["8","ï¼ï¼ï¼ãƒ»ãƒ»"], 
            ["9","ï¼ï¼ï¼ï¼ãƒ»"], 
            [".","ãƒ»ï¼ãƒ»ï¼ãƒ»ï¼"],
            [",","ï¼ï¼ãƒ»ãƒ»ï¼ï¼"],
            [":","ï¼ï¼ï¼ãƒ»ãƒ»ãƒ»"],
            ["?","ãƒ»ãƒ»ï¼ï¼ãƒ»ãƒ»"],
            ["'","ãƒ»ï¼ï¼ï¼ï¼ãƒ»"],
            ["ï¼","ï¼ãƒ»ãƒ»ãƒ»ãƒ»ï¼"],
            ["(","ï¼ãƒ»ï¼ï¼ãƒ»"],
            [")","ï¼ãƒ»ï¼ï¼ãƒ»ï¼"],
            ["/","ï¼ãƒ»ãƒ»ï¼ãƒ»"],
            ["=","ï¼ãƒ»ãƒ»ãƒ»ï¼"],
            ["+","ãƒ»ï¼ãƒ»ï¼ãƒ»"],
            ['"',"ãƒ»ï¼ãƒ»ãƒ»ï¼ãƒ»"],
            ["Ã—","ï¼ãƒ»ãƒ»ï¼"],
            ["@","ãƒ»ï¼ï¼ãƒ»ï¼ãƒ»"],
            ["a","ãƒ»ï¼"], //å°æ–‡å­—
            ["b","ï¼ãƒ»ãƒ»ãƒ»"],
            ["c","ï¼ãƒ»ï¼ãƒ»"],
            ["d","ï¼ãƒ»ãƒ»"],
            ["e","ãƒ»"],
            ["f","ãƒ»ãƒ»ï¼ãƒ»"],
            ["g","ï¼ï¼ãƒ»"],
            ["h","ãƒ»ãƒ»ãƒ»ãƒ»"],
            ["i","ãƒ»ãƒ»"],
            ["j","ãƒ»ï¼ï¼ï¼"],
            ["k","ï¼ãƒ»ï¼"],
            ["l","ãƒ»ï¼ãƒ»ãƒ»"],
            ["m","ï¼ï¼"],
            ["n","ï¼ãƒ»"],
            ["o","ï¼ï¼ï¼"],
            ["p","ãƒ»ï¼ï¼ãƒ»"],
            ["q","ï¼ï¼ãƒ»ï¼"],
            ["r","ãƒ»ï¼ãƒ»"],
            ["s","ãƒ»ãƒ»ãƒ»"],
            ["t","ï¼"],
            ["u","ãƒ»ãƒ»ï¼"],
            ["v","ãƒ»ãƒ»ãƒ»ï¼"],
            ["w","ãƒ»ï¼ï¼"],
            ["x","ï¼ãƒ»ãƒ»ï¼"],
            ["y","ï¼ãƒ»ï¼ï¼"],
            ["z","ï¼ï¼ãƒ»ãƒ»"],
            ["ï¼¡","ãƒ»ï¼"], //å…¨è§’
            ["ï¼¢","ï¼ãƒ»ãƒ»ãƒ»"],
            ["ï¼£","ï¼ãƒ»ï¼ãƒ»"],
            ["ï¼¤","ï¼ãƒ»ãƒ»"],
            ["ï¼¥","ãƒ»"],
            ["ï¼¦","ãƒ»ãƒ»ï¼ãƒ»"],
            ["ï¼§","ï¼ï¼ãƒ»"],
            ["ï¼¨","ãƒ»ãƒ»ãƒ»ãƒ»"],
            ["ï¼©","ãƒ»ãƒ»"],
            ["ï¼ª","ãƒ»ï¼ï¼ï¼"],
            ["ï¼«","ï¼ãƒ»ï¼"],
            ["ï¼¬","ãƒ»ï¼ãƒ»ãƒ»"],
            ["ï¼­","ï¼ï¼"],
            ["ï¼®","ï¼ãƒ»"],
            ["ï¼¯","ï¼ï¼ï¼"],
            ["ï¼°","ãƒ»ï¼ï¼ãƒ»"],
            ["ï¼±","ï¼ï¼ãƒ»ï¼"],
            ["ï¼²","ãƒ»ï¼ãƒ»"],
            ["ï¼³","ãƒ»ãƒ»ãƒ»"],
            ["ï¼´","ï¼"],
            ["ï¼µ","ãƒ»ãƒ»ï¼"],
            ["ï¼¶","ãƒ»ãƒ»ãƒ»ï¼"],
            ["ï¼·","ãƒ»ï¼ï¼"],
            ["ï¼¸","ï¼ãƒ»ãƒ»ï¼"],
            ["ï¼¹","ï¼ãƒ»ï¼ï¼"],
            ["ï¼º","ï¼ï¼ãƒ»ãƒ»"],
            ["ï½","ãƒ»ï¼"], //å…¨è§’å°æ–‡å­—
            ["ï½‚","ï¼ãƒ»ãƒ»ãƒ»"],
            ["ï½ƒ","ï¼ãƒ»ï¼ãƒ»"],
            ["ï½„","ï¼ãƒ»ãƒ»"],
            ["ï½…","ãƒ»"],
            ["ï½†","ãƒ»ãƒ»ï¼ãƒ»"],
            ["ï½‡","ï¼ï¼ãƒ»"],
            ["ï½ˆ","ãƒ»ãƒ»ãƒ»ãƒ»"],
            ["ï½‰","ãƒ»ãƒ»"],
            ["ï½Š","ãƒ»ï¼ï¼ï¼"],
            ["ï½‹","ï¼ãƒ»ï¼"],
            ["ï½Œ","ãƒ»ï¼ãƒ»ãƒ»"],
            ["ï½","ï¼ï¼"],
            ["ï½","ï¼ãƒ»"],
            ["ï½","ï¼ï¼ï¼"],
            ["ï½","ãƒ»ï¼ï¼ãƒ»"],
            ["ï½‘","ï¼ï¼ãƒ»ï¼"],
            ["ï½’","ãƒ»ï¼ãƒ»"],
            ["ï½“","ãƒ»ãƒ»ãƒ»"],
            ["ï½”","ï¼"],
            ["ï½•","ãƒ»ãƒ»ï¼"],
            ["ï½–","ãƒ»ãƒ»ãƒ»ï¼"],
            ["ï½—","ãƒ»ï¼ï¼"],
            ["ï½˜","ï¼ãƒ»ãƒ»ï¼"],
            ["ï½™","ï¼ãƒ»ï¼ï¼"],
            ["ï½š","ï¼ï¼ãƒ»ãƒ»"],
            ["ï¼ˆ","ï¼ãƒ»ï¼ï¼ãƒ»ï¼"], //( ï¼101
            [")","ãƒ»ï¼ãƒ»ãƒ»ï¼ãƒ»"], //) ï¼102 
            ["ï¼","ï¼ï¼ï¼ï¼ï¼"], //0 ï¼103
            ["ï¼‘","ãƒ»ï¼ï¼ï¼ï¼"], //1 ï¼104
            ["ï¼’","ãƒ»ãƒ»ï¼ï¼ï¼"], //2 ï¼105
            ["ï¼“","ãƒ»ãƒ»ãƒ»ï¼ï¼"], //3 ï¼106
            ["ï¼”","ãƒ»ãƒ»ãƒ»ãƒ»ï¼"], //4 ï¼107
            ["ï¼•","ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»"], //5 ï¼108
            ["ï¼–","ï¼ãƒ»ãƒ»ãƒ»ãƒ»"], //6 ï¼109
            ["ï¼—","ï¼ï¼ãƒ»ãƒ»ãƒ»"], //7 ï¼110
            ["ï¼˜","ï¼ï¼ï¼ãƒ»ãƒ»"], //8 ï¼111
            ["ï¼™","ï¼ï¼ï¼ï¼ãƒ»"], //9 ï¼112
        ];

        let iroha_name = [];
        let morse_name = [];
        let quiz_iroha= [];
        let quiz_morse = [];
        let invalidChars = [];
        let speedRatio = 1;
        let SPEED = 0.15; // ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·ã®é€Ÿã•(å‰ã®3å€é…ã„)
        let DIFFICULTY = 'normal'; //æ–‡å­—ã¨æ–‡å­—ã®é–“éš” normalãŒã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒˆ
        let frequency = 880; //ãƒ¢ãƒ¼ãƒ«ã‚¹ã®éŸ³ã®é«˜ã•
        let currentMp3Blob = null; // ä¸€ç•ªæ–°ã—ã„mp3(Binary Large Object)
        const channels = 1; //ãƒãƒ£ãƒ³ãƒãƒ«æ•°
        let volume = 1; //éŸ³ã®å¤§ãã•

        let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let currentOscillators = [];


        let current_language = iroha;
        let lang = document.getElementById("language");

        //å…¥åŠ›å…ƒã¨å‡ºåŠ›å…ˆã‚’å¼•æ•°ã«æ¸¡ã™ã¨ã„ã‚ã¯ã‚’ãƒ¢ãƒ¼ãƒ«ã‚¹ã«å¤‰ãˆã¦å‡ºåŠ›ã™ã‚‹
        function ChangeIroha(inputID,outputID){
            quiz_morse = [];
            const getname = document.getElementById(inputID).value;        
            quiz_iroha = getname.split("");
            for(let char of quiz_iroha){
                const found = current_language.find(data => data[0] === char); //æ¢ç´¢
                if(found){
                    quiz_morse.push(found[1]);
                }else{ //æœªå®šç¾©ã®æ–‡å­—ãŒã‚ã£ãŸå ´åˆ
                    quiz_morse.push("ï¼Ÿ")
                }
            }
            let morse = quiz_morse.join('ï¼');
            document.getElementById(outputID).value = morse;
            return morse;
        }


        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®æ¶ˆå»ãŒä¸Šã¨é•ã†
        function ChangeIrohaNAME(inputID,outputID){
            morse_name = []; //åˆæœŸåŒ–
            const getname = document.getElementById(inputID).value;        
            iroha_name = getname.split("");
            for(let char of iroha_name){
                const found = current_language.find(data => data[0] === char); //æ¢ç´¢
                if(found){
                    morse_name.push(found[1]);
                }else{ //æœªå®šç¾©ã®æ–‡å­—ãŒã‚ã£ãŸå ´åˆ
                    morse_name.push("ï¼Ÿ")
                }
            }
            let morse = morse_name.join('ï¼');
            document.getElementById(outputID).value = morse;
            const btn = document.getElementById("downloadBtn");
            btn.style.display = "none";
            return morse;
        }

        //ã„ã‚ã¯ã‚’ç›´æ¥å…¥ã‚Œã‚‹ã¨å¯¾å¿œã™ã‚‹ãƒ¢ãƒ¼ãƒ«ã‚¹ã‚’è¿”ã™
        function DirectChangeIroha(IROHA){
             quiz_morse = []; //åˆæœŸåŒ–
             IROHA = IROHA.split("");
              for(let char of IROHA){
                const found = current_language.find(data => data[0] === char); //æ¢ç´¢
                if(found){
                    quiz_morse.push(found[1]);
                }else{ //æœªå®šç¾©ã®æ–‡å­—ãŒã‚ã£ãŸå ´åˆ
                    quiz_morse.push("ï¼Ÿ");
                }
            }
            let morse = quiz_morse.join('ï¼');
            return morse;
        }

        //ã„ã‚ã¯ã‚’ç›´æ¥å…¥ã‚Œã‚‹ã¨å¯¾å¿œã™ã‚‹ãƒ¢ãƒ¼ãƒ«ã‚¹ã‚’è¿”ã™
        function DirectChangeIrohaNAME(IROHA){
             morse_name = []; //åˆæœŸåŒ–
             IROHA = IROHA.split("");
              for(let char of IROHA){
                const found = current_language.find(data => data[0] === char); //æ¢ç´¢
                if(found){
                    morse_name.push(found[1]);
                }else{ //æœªå®šç¾©ã®æ–‡å­—ãŒã‚ã£ãŸå ´åˆ
                    morse_name.push("ï¼Ÿ");
                }
            }
            let morse = morse_name.join('ï¼');
            return morse;
        }

        // 2æ–‡å­—åˆ¤å®šã®æ¿ç‚¹ã‚„åŠæ¿ç‚¹ã®ã¤ã„ãŸæ–‡å­—ã‚’1æ–‡å­—ã«
        function Conversion(array){
            array = array.split("ã‹ã‚›").join('ãŒ');
            array = array.split("ãã‚›").join('ã');
            array = array.split("ãã‚›").join('ã');
            array = array.split("ã‘ã‚›").join('ã’');
            array = array.split("ã“ã‚›").join('ã”');
            array = array.split("ã•ã‚›").join('ã–');
            array = array.split("ã—ã‚›").join('ã˜');
            array = array.split("ã™ã‚›").join('ãš');
            array = array.split("ã›ã‚›").join('ãœ');
            array = array.split("ãã‚›").join('ã');
            array = array.split("ãŸã‚›").join('ã ');
            array = array.split("ã¡ã‚›").join('ã¢');
            array = array.split("ã¤ã‚›").join('ã¥');
            array = array.split("ã¦ã‚›").join('ã§');
            array = array.split("ã¨ã‚›").join('ã©');
            array = array.split("ã¯ã‚›").join('ã°');
            array = array.split("ã²ã‚›").join('ã³');
            array = array.split("ãµã‚›").join('ã¶');
            array = array.split("ã¸ã‚›").join('ã¹');
            array = array.split("ã»ã‚›").join('ã¼');
            array = array.split("ã¯ã‚œ").join('ã±');
            array = array.split("ã²ã‚œ").join('ã´');
            array = array.split("ãµã‚œ").join('ã·');
            array = array.split("ã¸ã‚œ").join('ãº');
            array = array.split("ã»ã‚œ").join('ã½');
            return array;
        }

        // ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·ã®å†ç”Ÿ
        function playMorse(id){
            // const morse = document.getElementById(id).value;
            let morse =[];
            if(id == 'NAME'){morse = morse_name.join('ï¼');}
            else{morse = document.getElementById(id).value;}

            // å‰å›ã®éŸ³ã‚’æ­¢ã‚ã‚‹
            currentOscillators.forEach(osc => {
                try { osc.stop(); } catch (e) {}
            });
            currentOscillators = [];

            // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆéŸ³ãŒé€”ä¸­ã§æ®‹ã‚‰ãªã„ã‚ˆã†ã«ï¼‰
            audioCtx.close();

            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const dot = SPEED * speedRatio; 
            let time = audioCtx.currentTime; // å†ç”Ÿé–‹å§‹æ™‚åˆ»

            animateMorseFlow(morse);

            for(let char of morse){
                if(char === "ãƒ»"){
                    ring(audioCtx, time, dot);
                    time += dot + dot; // ã€Œãƒ»ã€ + ã€Œç©ºç™½ã€ ((1ç‚¹ + 1ç‚¹
                } else if(char === "ï¼" || char === "-"){
                    ring(audioCtx, time, dot * 3);
                    time += dot * 3 + dot; // ã€Œï¼ã€ + ã€Œç©ºç™½ã€ ((3ç‚¹ + 1ç‚¹
                } else if(char === "ï¼" && DIFFICULTY === 'normal'){
                    time += dot * 2; // æ–‡å­—ã¨æ–‡å­—ã®é–“ 3ç‚¹(ä¸Šã®ç©ºç™½åˆ† + 2ç‚¹)
                } else if(char === "ï¼" && DIFFICULTY === 'easy'){
                    time += dot * 5; // æ–‡å­—ã¨æ–‡å­—ã®é–“ 6ç‚¹(ä¸Šã®ç©ºç™½åˆ† + 5ç‚¹)
                } else if(char === "ï¼Ÿ"){ //  ?ã®å‡¦ç†ã©ã†ã—ã‚ˆã†
                    time += dot ;
                }
            }
        }

        //ãƒ“ãƒ¼ãƒ—éŸ³ã‚’é³´ã‚‰ã™(èãã¨ãç”¨)
        function ring(ctx, start, duration){
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            oscillator.type = "sine";
            // éŸ³é‡ã®è¨­å®š
            oscillator.frequency.setValueAtTime(frequency, start);
            gainNode.gain.setValueAtTime(volume, start); //éŸ³é‡volumeã§ã‚¹ã‚¿ãƒ¼ãƒˆ
            gainNode.gain.setValueAtTime(0, start + duration); //durationåˆ†ãŸã£ãŸã‚‰0ã«ã™ã‚‹ 
            // éŸ³ã®è¨­å®š
            oscillator.connect(gainNode).connect(ctx.destination); //éŸ³é‡èª¿æ•´->ã‚¹ãƒ”ãƒ¼ã‚«ã«æ¥ç¶š
            oscillator.start(start); //startæ™‚ã«å§‹ã‚ã‚‹
            oscillator.stop(start + duration);//durationçµŒéã§çµ‚äº†

            currentOscillators.push(oscillator); //ç¾åœ¨ã®ã‚‚ã®ã‚’è¨˜éŒ²
        }

        //ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·ã®æ›¸ã‹ã‚Œã¦ã„ã‚‹å ´æ‰€ã‚’æŒ‡å®šã™ã‚‹ã¨ã„ã‚ã¯ã«å¤‰æ›´
        function ChangeMorse(inputID){
            const morseInput = document.getElementById(inputID).value;
            const getMorse = morseInput.split("ï¼");
            let result = "";
            invalidChars = [];
            for(let code of getMorse){
                const found = current_language.find(data => data[1] === code);
                if(found){
                    result += found[0];
                }else{
                    result += "ï¼Ÿ";
                    invalidChars.push(code);
                }
            }
            // showMorseResult(DirectChangeMorse(morseInput));
            result = Conversion(result);
            if(morseInput === morse_name.join('ï¼')){
                showFloatingResult(result,1,invalidChars);
            }
            else{
                showFloatingResult(result,0,invalidChars);
            }
            return result;
        }

        //ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·ã‚’ç›´æ¥å…¥ã‚Œã‚‹ã¨å¯¾å¿œã™ã‚‹ã„ã‚ã¯ã‚’ã‹ãˆã™
        function DirectChangeMorse(morse){
            const getMorse = morse.split("ï¼");
            let result = "";
            for(let code of getMorse){
                const found = current_language.find(data => data[1] === code);
                if(found){
                    result += found[0];
                }else{
                    result += "ï¼Ÿ";
                }
            }
            return result;
        }



        //é€Ÿã•å¤‰æ›´
        function ChangeSpeed(ratio){
            speedRatio = 1.0 / ratio;
            const btn = document.getElementById("downloadBtn");
            btn.style.display = "none";
        }


        // ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·ã‚’mp3ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›
        async function morseToMp3(morseString) {
            const sampleRate = 44100; //ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°å‘¨æ³¢æ•°
            let unit = SPEED * speedRatio;
            let totalDuration = 0;

            for (let char of morseString) {
                if (char === "ãƒ»"){totalDuration += unit + unit;}
                else if (char === "ï¼"){totalDuration += unit * 3 + unit;}
                else if (char === "ï¼"){totalDuration += unit * 2;}
            }


            const offlineCtx = new OfflineAudioContext(channels, sampleRate * totalDuration, sampleRate);
            let time = 0;

            for (let char of morseString) {
                if (char === "ãƒ»") {
                    addBeep(offlineCtx, time, unit, frequency);
                    time += unit + unit;
                } else if (char === "ï¼") {
                    addBeep(offlineCtx, time, unit * 3, frequency);
                    time += unit * 3 + unit;
                } else if (char === "ï¼") {
                    time += unit * 2;
                }
            }

            const audioBuffer = await offlineCtx.startRendering();
            return audioBufferToMp3(audioBuffer);
        }

        // éŸ³ã‚’ãƒ“ãƒ¼ãƒ—éŸ³ã§é³´ã‚‰ã™(éŒ²éŸ³ç”¨)
        function addBeep(ctx, startTime, duration, frequency) {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.frequency.value = frequency;
            osc.type = 'sine';
            osc.connect(gain);
            gain.connect(ctx.destination);
            gain.gain.setValueAtTime(volume, startTime);
            gain.gain.setValueAtTime(0, startTime + duration);
            osc.start(startTime);
            osc.stop(startTime + duration);
        }

        // AudioBuffer â†’ MP3 ã«å¤‰æ›
        function audioBufferToMp3(audioBuffer) {
            const samples = audioBuffer.getChannelData(0);
            const mp3encoder = new lamejs.Mp3Encoder(channels, audioBuffer.sampleRate, 128);
            const sampleBlockSize = 1152;
            const mp3Data = [];

            for (let i = 0; i < samples.length; i += sampleBlockSize) {
                const sampleChunk = samples.subarray(i, i + sampleBlockSize);
                const int16Samples = new Int16Array(sampleChunk.length);
                for (let j = 0; j < sampleChunk.length; j++) {
                    int16Samples[j] = sampleChunk[j] * 32767;
                }
                const mp3buf = mp3encoder.encodeBuffer(int16Samples);
                if (mp3buf.length > 0) mp3Data.push(mp3buf);
            }

            const mp3buf = mp3encoder.flush();
            if (mp3buf.length > 0) mp3Data.push(mp3buf);

            return new Blob(mp3Data, { type: 'audio/mp3' });
        }

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }


        //LINEã‹ã©ã†ã‹ã®åˆ¤æ–­
        function isLineBrowser() {
            const ua = navigator.userAgent.toLowerCase();
            return ua.includes("line");
        }

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        async function generateMorseMp3(id) {
        const morse = document.getElementById(id).value;
            if (!morse.trim()) {
                alert("ä½•ã‚‚å…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“");
                return;
            }

            if (isLineBrowser()) {
                alert("LINEã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯MP3ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã€‚\nå³ä¸‹ã®ã€Œâ€¦ã€ã‹ã‚‰ã€Œãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã€ã¾ãŸã¯Safari/Chromeã§é–‹ã„ã¦ãã ã•ã„ã€‚");
                return;
            }

            const blob = await morseToMp3(morse);
            currentMp3Blob = blob;

            const btn = document.getElementById("downloadBtn");
            btn.style.display = "inline-block";
            btn.onclick = () => {
                //ãƒ•ã‚¡ã‚¤ãƒ«åã«ç¾åœ¨æ™‚åˆ»ã‚’æ¡ç”¨
                // const now = new Date();
                // const timestamp = now.toISOString().replace(/[:.]/g, '-');
                //  const filename = `morse_${timestamp}.mp3`;

                //ãƒ•ã‚¡ã‚¤ãƒ«åã«å¤‰æ›ã—ãŸæ–‡å­—ã‚’æ¡ç”¨
                let originalText = iroha_name.join("");
                if (originalText.length > 20) {
                    originalText = originalText.substring(0, 20) + "ãƒ»ãƒ»ãƒ»";
                }
                const filename = `ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·_${originalText}.mp3`;
                downloadBlob(currentMp3Blob, filename);
                window.alert(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼\nãƒ•ã‚¡ã‚¤ãƒ«å: ${filename}`);
            }

        }

        //éŸ³ã®æµã‚Œã‚‹é€Ÿã•ã‚’è¿”ã™ã€€ã€‡å€é€Ÿ
        function getSpeedRatio(){ 
            return speedRatio;
        }

        //éŸ³ã®é«˜ã•ã‚’è¿”ã™ã€€åŸºæœ¬880Hz
        function getFrequency(){
            return frequency;
        }

        //éŸ³ã®å¤§ãã•ã‚’è¿”ã™ 0~1
        function getVolume(){ 
            return volume;
        }

        //éŸ³ã®å¤§ãã•ã‚’è¨­å®š 0~1
        function setVolume(newVolume){ 
            volume = Math.pow(newVolume, 2); //éŸ³é‡ã‚’2ä¹—ã—ã¦å°ã•ã„éŸ³ã‚‚èã“ãˆã‚‹ã‚ˆã†ã«
        }

        //éŸ³ã®é«˜ã•ã‚’è¨­å®š
        function setFrequency(newFrequency){ 
            frequency = newFrequency;
        }

        function setSpeed(){ 
            return speedRatio;
        }
                
    function appendText(char,id) {
      const textbox = document.getElementById(id);
      textbox.value += char;
    }

    function deleteLast(id) {
      const textbox = document.getElementById(id);
      // æœ€å¾Œã®1æ–‡å­—ã‚’å‰Šé™¤ï¼ˆUTF-16ã‚³ãƒ¼ãƒ‰å˜ä½ã«å¯¾å¿œï¼‰
      textbox.value = textbox.value.slice(0, -1);
    }

    function clearText(id) {
      const textbox = document.getElementById(id);
      textbox.value = '';
    }


// ========================
// ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
// ========================
// ===== ãƒ¢ãƒ¼ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³èª¿æ•´ç”¨ =====
// èª¿æ•´ç”¨å®šæ•°
// const MORSE_ANIMATION_BASE_DURATION = 3; // 1ç‚¹(dot)ã®é•·ã•ï¼ˆç§’ï¼‰ã¨åˆã‚ã›ã‚‹

// const MORSE_ANIMATION_FLOW_DURATION = 10.0; // ç”»é¢ã‚’æµã‚Œã‚‹æ™‚é–“ï¼ˆç§’ï¼‰ãŠå¥½ã¿ã§èª¿æ•´

const DELAY_RATIO = 0.5; // 0.5å€ã«è©°ã‚ã‚‹ï¼ˆãŠå¥½ã¿ã§èª¿æ•´ï¼‰

function setMorseEndPosition(value) {
  document.documentElement.style.setProperty('--morse-end-position', value);
}

function animateMorseFlow(morseStr) {
  const flow = document.getElementById('morseFlow');
  flow.innerHTML = '';
  let baseDelay = 0;
  const dot = SPEED;

  const flowWidth = flow.offsetWidth; // flowé ˜åŸŸã®pxå¹…
  const endMargin = 8000; // è¿½åŠ è·é›¢(px) ã´Ã—20ã«å¯¾å¿œ
  const totalDistance = flowWidth + endMargin;

    const flowSpeed = 125 / speedRatio; // ãƒ¢ãƒ¼ãƒ«ã‚¹ã®ã‚¹ãƒ”ãƒ¼ãƒ‰
    const animationDurationSec = totalDistance / flowSpeed;

    setMorseEndPosition(`${-totalDistance}px`);

    let delayRatio = DELAY_RATIO * speedRatio;

    for (let i = 0; i < morseStr.length; i++) {
        const ch = morseStr[i];
        if (!'ãƒ»ï¼ï¼'.includes(ch)) continue;

        const span = document.createElement('span');
        span.className = 'morse-flow-char';
        span.textContent = ch;

        span.style.animationDelay = `${baseDelay * delayRatio}s`;
        span.style.animationDuration = `${animationDurationSec}s`;

        flow.appendChild(span);

        if (ch === "ãƒ»"){baseDelay += dot + dot;}
        else if (ch === "ï¼" || ch === "-"){baseDelay += dot*2 + dot;}
        else if (ch === "ï¼"){baseDelay += dot * 2;}
    }

}

function showMorseResult(text){
    const resultDiv = document.getElementById("morseResult");
    resultDiv.textContent = text;
    
    // å†ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã®ã‚¯ãƒ©ã‚¹ãƒªã‚»ãƒƒãƒˆ
    resultDiv.classList.remove("morse-float");
    void resultDiv.offsetWidth; // DOMå†æç”»ã‚’å¼·åˆ¶
    resultDiv.classList.add("morse-float");
}

function showFloatingResult(text, isCorrect = false,invalidChars = []){
    const resultDiv = document.getElementById("morseResult");
    const correctDiv = document.getElementById("correctMessage");


    if (!text || text.trim() === "") {
        window.alert("ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·ãŒç©ºã§ã™ã€‚\nãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    if (text.includes("ï¼Ÿ")){
        const unique = [...new Set(invalidChars)].join("\n");
        window.alert(`å­˜åœ¨ã—ãªã„ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·ãŒå«ã¾ã‚Œã¦ã„ã¾ã™:\n${unique}\n`);
        return;
    }

    // å¤‰æ›æ–‡å­—è¡¨ç¤º
    resultDiv.textContent = text;
    resultDiv.classList.remove("morse-float");
    void resultDiv.offsetWidth;
    resultDiv.classList.add("morse-float");

    // æ­£è§£ãƒ»ä¸æ­£è§£è¡¨ç¤º
    correctDiv.classList.remove("correct-float", "incorrect-float");
    void correctDiv.offsetWidth;

    if (isCorrect) {
        correctDiv.textContent = "ãŠã‚ã§ã¨ã†ğŸ‰";
        correctDiv.classList.add("correct-float");
    } else {
        correctDiv.textContent = ""
    }
}

function showJudgeMark(isCorrect) {
    const judgeMark = document.getElementById("judgeMark");

    // ä¸€æ—¦ class ã‚’å‰Šé™¤ã—ã¦å¼·åˆ¶çš„ã«åˆæœŸåŒ–
    judgeMark.classList.remove("judge-correct", "judge-incorrect");

    // å¼·åˆ¶å†æç”»
    void judgeMark.offsetWidth;

    // åˆ¤å®šãƒãƒ¼ã‚¯ã®å†…å®¹ã¨ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
    judgeMark.textContent ="";
    if (isCorrect === 1) {
        judgeMark.textContent = "ã€‡";
        judgeMark.className = "judge-mark judge-correct";
    } else if(isCorrect === 0) {
        judgeMark.textContent = "Ã—";
        judgeMark.className = "judge-mark judge-incorrect";
    }

}

function playDot(){
    currentOscillators.forEach(osc => {
        try { osc.stop(); } catch (e) {}
    });
    currentOscillators = [];
    audioCtx.close();
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const dot = SPEED * speedRatio; 
    let time = audioCtx.currentTime; // å†ç”Ÿé–‹å§‹æ™‚åˆ»
    ring(audioCtx,time,dot);
}

function playDash(){
    currentOscillators.forEach(osc => {
        try { osc.stop(); } catch (e) {}
    });
    currentOscillators = [];
    audioCtx.close();
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const dot = SPEED * speedRatio; 
    let time = audioCtx.currentTime; // å†ç”Ÿé–‹å§‹æ™‚åˆ»
    ring(audioCtx,time,dot*3);
}

// ===== MP3 ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»è§£ææ©Ÿèƒ½ =====
// ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‹ã‚‰è§£æã‚’è¡Œã†
async function analyzeUploadedFile(){
    const input = document.getElementById('audioFile');
    const file = input.files && input.files[0];
    if(!file){
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    const reader = new FileReader();
    reader.onload = async function(e){
        document.getElementById('analyzeInfo').textContent = 'è§£æä¸­...';
        const arrayBuffer = e.target.result;
        try{
            const morse = await analyzeAudioBuffer(arrayBuffer);
            document.getElementById('analyzedMorse').value = morse;
            document.getElementById('analyzedMorseToIroha').value = showDecodedFromAnalyzed();
            document.getElementById('analyzeInfo').textContent = 'è§£æå®Œäº†';
        }catch(err){
            console.error(err);
            alert('è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
            document.getElementById('analyzeInfo').textContent = 'è§£æã‚¨ãƒ©ãƒ¼';
        }
    };
    reader.readAsArrayBuffer(file);
}

// ArrayBuffer ã‚’ AudioBuffer ã«ã—ã¦è§£æã™ã‚‹
async function analyzeAudioBuffer(arrayBuffer){
    // decode
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const audioBuffer = await ctx.decodeAudioData(arrayBuffer);
    const sampleRate = audioBuffer.sampleRate;
    const channelData = audioBuffer.getChannelData(0);

    // envelope ã‚’ä½œæˆ (5ms window)
    const windowMs = 5; // ms
    const windowSize = Math.max(1, Math.floor(sampleRate * (windowMs/1000)));
    const envelope = [];
    let maxEnv = 0;
    for(let i = 0; i < channelData.length; i += windowSize){
        let sum = 0;
        let end = Math.min(i + windowSize, channelData.length);
        for(let j = i; j < end; j++){
            sum += Math.abs(channelData[j]);
        }
        let rms = sum / (end - i);
        envelope.push(rms);
        if(rms > maxEnv) maxEnv = rms;
    }

    // threshold ã‚’è‡ªå‹•æ±ºå®šï¼ˆãƒã‚¤ã‚ºã®å‰²åˆã‚’è€ƒæ…®ï¼‰
    const sorted = Array.from(envelope).sort((a,b)=>a-b);
    const noiseLevel = sorted[Math.floor(sorted.length * 0.25)] || 0; // 25%ç‚¹
    const signalLevel = sorted[Math.floor(sorted.length * 0.98)] || maxEnv; // 98%ç‚¹
    // threshold ã‚’ noise ã¨ signal ã®ä¸­é–“çš„ãªå€¤ã«è¨­å®š
    let threshold = Math.max(noiseLevel + (signalLevel - noiseLevel) * 0.25, maxEnv * 0.06);

    // binary ã‚ªãƒ³/ã‚ªãƒ•é…åˆ—
    const onOff = envelope.map(v => v >= threshold ? 1 : 0);

    // segment åŒ–ã—ã¦æ™‚é–“ã‚’æ¸¬ã‚‹
    const segments = []; // {isOn: boolean, frames: n}
    let current = onOff[0];
    let count = 1;
    for(let i = 1; i < onOff.length; i++){
        if(onOff[i] === current){ count++; }
        else{ segments.push({isOn: !!current, frames: count}); current = onOff[i]; count = 1; }
    }
    segments.push({isOn: !!current, frames: count});

    // ãƒ•ãƒ¬ãƒ¼ãƒ  -> sec
    const unitSec = windowSize / sampleRate; // sec per envelope frame
    const toneDurations = segments.filter(s => s.isOn).map(s => s.frames * unitSec);
    const silenceDurations = segments.filter(s => !s.isOn).map(s => s.frames * unitSec);

    if(toneDurations.length === 0){
        throw new Error('éŸ³ãŒæ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ');
    }

    // dotUnit ã®æ¨å®š: çŸ­ã„ãƒˆãƒ¼ãƒ³ã®ä¸­å¤®å€¤
    const sortedTones = toneDurations.slice().sort((a,b)=>a-b);
    const cutoff = Math.max(1, Math.floor(sortedTones.length * 0.3));
    const shortestSlice = sortedTones.slice(0, cutoff);
    const dotUnit = median(shortestSlice);

    // æ§‹ç¯‰ï¼šãƒ¢ãƒ¼ãƒ«ã‚¹è¡¨è¨˜(ãƒ»,ï¼,ï¼)
    let morseStr = '';
    for(let i = 0; i < segments.length; i++){
        const seg = segments[i];
        if(seg.isOn){
            const dur = seg.frames * unitSec;
            if(dur <= dotUnit * 1.8){ morseStr += 'ãƒ»'; }
            else{ morseStr += 'ï¼'; }
        }else{
            const dur = seg.frames * unitSec;
            // silence åˆ¤å®š
            if(dur > dotUnit * 5){ // wordé–“
                morseStr += 'ï¼'; // word gap (use same separator for simplicity)
            }else if(dur > dotUnit * 2.5){ // letteré–“
                morseStr += 'ï¼';
            }else{
                // intra element gap, do nothing
            }
        }
    }

    // æç”»
    drawAudioCanvas('audioCanvas', channelData, sampleRate, envelope, threshold, windowSize);

    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆé€£ç¶šã®åŒºåˆ‡ã‚Šã‚’1ã¤ã«ï¼‰
    morseStr = morseStr.replace(/ï¼+/g,'ï¼');
    // å…ˆé ­æœ«å°¾ã®ä¸è¦åŒºåˆ‡ã‚Šã‚’é™¤å»
    morseStr = morseStr.replace(/(^ï¼+|ï¼+$)/g,'');
    return morseStr;
}

// median helper
function median(arr){
    if(arr.length === 0) return 0;
    const s = arr.slice().sort((a,b)=>a-b);
    const mid = Math.floor(s.length/2);
    if(s.length % 2 === 0) return (s[mid-1] + s[mid]) / 2;
    return s[mid];
}

// draw waveform + envelope + threshold marker
function drawAudioCanvas(canvasId, samples, sampleRate, envelope, threshold, windowSize){
    const canvas = document.getElementById(canvasId);
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width = canvas.clientWidth * (window.devicePixelRatio || 1);
    const h = canvas.height = canvas.clientHeight * (window.devicePixelRatio || 1);
    ctx.clearRect(0,0,w,h);
    ctx.save();
    // draw waveform in light gray
    ctx.fillStyle = '#f8f8f8';
    ctx.fillRect(0,0,w,h);
    ctx.strokeStyle = '#999';
    ctx.lineWidth = 1;
    ctx.beginPath();
    const step = Math.ceil(samples.length / w);
    for(let i = 0; i < w; i++){
        const idx = i * step;
        const v = samples[idx] || 0;
        const y = (1 - (v + 1) / 2) * h; // normalize between -1..1
        if(i === 0) ctx.moveTo(i, y);
        else ctx.lineTo(i, y);
    }
    ctx.stroke();

    // draw threshold and envelope as bars
    const envStep = envelope.length / w;
    for(let x = 0; x < w; x++){
        const idx = Math.floor(x * envStep);
        const val = envelope[idx] || 0;
        const barH = Math.min(1, val / (threshold*3)) * h;
        ctx.fillStyle = val >= threshold ? 'rgba(0,150,0,0.25)' : 'rgba(200,200,200,0.12)';
        ctx.fillRect(x, h - barH, 1, barH);
    }
    // threshold line
    ctx.strokeStyle = 'rgba(255,0,0,0.9)';
    ctx.beginPath();
    const thrY = h - Math.min(1, threshold / (threshold*3)) * h;
    ctx.moveTo(0, thrY);
    ctx.lineTo(w, thrY);
    ctx.stroke();
    ctx.restore();
}

// ãƒ†ã‚­ã‚¹ãƒˆã®ãƒ¢ãƒ¼ãƒ«ã‚¹ã‚’å…ƒã«æ–‡å­—ã«å¤‰æ›ã—ã¦è¡¨ç¤º
function showDecodedFromAnalyzed(){
    const morseStr = document.getElementById('analyzedMorse').value;
    if(!morseStr || morseStr.trim() === ''){
        alert('è§£æçµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšéŸ³å£°ã‚’è§£æã—ã¦ãã ã•ã„');
        return;
    }
    const decoded = DirectChangeMorse(morseStr);
    if(decoded){
        // show in morseResult area
        return decoded;
    }
}


lang.addEventListener("change", function (e) {
    changeLanguage(lang.value);
       document.getElementById("span4").textContent = lang.value;
    });

    // DOMContentLoaded ã§ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‰
    window.addEventListener('DOMContentLoaded', () => {
        const audioInput = document.getElementById('audioFile');
        if(audioInput){
            audioInput.addEventListener('change', () => {
                // optional: you can auto-analyze
                // analyzeUploadedFile();
                document.getElementById('analyzeInfo').textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚è§£æãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„';
            });
        }
    });

function changeLanguage(languageName){
    if(languageName === "æ—¥æœ¬èª"){
        current_language = iroha;
    
        console.log("æ—¥æœ¬èªé¸æŠ\n");
        document.getElementById("h1").innerHTML = "ğŸµ ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·ä½“é¨“ã‚¢ãƒ—ãƒª ğŸ“¡";
        document.getElementById("inline-character-balloon").innerHTML = "åƒ•ã¨ä¸€ç·’ã«ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·ã‚’å­¦ã¼ã†ï¼";
        document.getElementById("welcome-text").innerHTML = "ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·ã®ä¸–ç•Œã¸ã‚ˆã†ã“ãï¼<br>\
        ã‚ãªãŸã®åå‰ã‚’ãƒ¢ãƒ¼ãƒ«ã‚¹ä¿¡å·ã«å¤‰æ›ã—ãŸã‚Šã€å®Ÿéš›ã«ãƒ¢ãƒ¼ãƒ«ã‚¹å…¥åŠ›ã‚’ä½“é¨“ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚";
        document.getElementById("h2").innerHTML = "ã‚ãªãŸã®ãŠåå‰ã‚’æ•™ãˆã¦ãã ã•ã„";
        document.getElementById("volume").innerHTML = "éŸ³é‡";
        document.getElementById("TestPlayback").innerHTML = "ãƒ†ã‚¹ãƒˆå†ç”Ÿ";
        document.getElementById("start").innerHTML = "ã¯ã˜ã‚ã‚‹";
        document.getElementById("inputName").innerHTML = "åå‰å…¥åŠ›";
        document.getElementById("change_playback").innerHTML = "å¤‰æ›ãƒ»å†ç”Ÿ";
        document.getElementById("inputMores").innerHTML = "ãƒ¢ãƒ¼ãƒ«ã‚¹å…¥åŠ›";
        document.getElementById("finish").innerHTML = "å®Œäº†";
        document.getElementById("input").innerHTML = "ã²ã‚‰ãŒãªã§å…¥åŠ›ã—ã¦ã­ï¼";
        document.getElementById("nameInput").placeholder = "ãŠåå‰ã‚’ã²ã‚‰ãŒãªã§å…¥åŠ›(æœ€å¤§20æ–‡å­—)";
        document.getElementById("back").innerHTML = "æˆ»ã‚‹";
        document.getElementById("change").innerHTML = "å¤‰æ›ã™ã‚‹";
        
    }else{
        current_language = rome;
        console.log("English\n");
        document.getElementById("h1").innerHTML = "ğŸµ Morse Code Experience App ğŸ“¡";
        document.getElementById("inline-character-balloon").innerHTML = "Let's learn Morse code together!";
        document.getElementById("welcome-text").innerHTML = "Welcome to the world of Morse code!<br>\
        Convert your name into Morse code, and try experiencing Morse code input for yourself.";
        document.getElementById("h2").innerHTML = "Please tell me your name.";
        document.getElementById("volume").innerHTML = "Volume";
        document.getElementById("TestPlayback").innerHTML = "Test Playback";
        document.getElementById("start").innerHTML = "START";
        document.getElementById("inputName").innerHTML = "Input your name";
        document.getElementById("change_playback").innerHTML = "Conversion and Playback";
        document.getElementById("inputMores").innerHTML = "ãƒ¢ãƒ¼ãƒ«ã‚¹å…¥åŠ›";
        document.getElementById("finish").innerHTML = "å®Œäº†";
        document.getElementById("input").innerHTML = "ã²ã‚‰ãŒãªã§å…¥åŠ›ã—ã¦ã­ï¼";
        document.getElementById("nameInput").placeholder = "ãŠåå‰ã‚’ã²ã‚‰ãŒãªã§å…¥åŠ›(æœ€å¤§20æ–‡å­—)";
        document.getElementById("back").innerHTML = "æˆ»ã‚‹";
        document.getElementById("change").innerHTML = "å¤‰æ›ã™ã‚‹";
    }
}


